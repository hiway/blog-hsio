<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Harshad's Blog - Mastodon</title><link href="https://blog.harshad.sharma.io/" rel="alternate"></link><link href="https://blog.harshad.sharma.io/feeds/mastodon.atom.xml" rel="self"></link><id>https://blog.harshad.sharma.io/</id><updated>2023-07-04T00:00:00+05:30</updated><entry><title>Putting your Mastodon on a diet</title><link href="https://blog.harshad.sharma.io/posts/2023/Jul/04/putting-your-mastodon-on-a-diet/" rel="alternate"></link><published>2023-07-04T00:00:00+05:30</published><updated>2023-07-04T00:00:00+05:30</updated><author><name>Harshad Sharma</name></author><id>tag:blog.harshad.sharma.io,2023-07-04:/posts/2023/Jul/04/putting-your-mastodon-on-a-diet/</id><summary type="html">&lt;p&gt;I have been preparing to move my Mastodon instance from self-hosted in the cloud to shelf-hosted at home.
Since November 2022, I have accumulated 80+ GB of media and a 1.2GB database - 
this is while having &lt;code&gt;Media cache retention period&lt;/code&gt; under 
Settings &amp;gt; Administration &amp;gt; Server Settings &amp;gt; Content retention set at â€¦&lt;/p&gt;</summary><content type="html">&lt;p&gt;I have been preparing to move my Mastodon instance from self-hosted in the cloud to shelf-hosted at home.
Since November 2022, I have accumulated 80+ GB of media and a 1.2GB database - 
this is while having &lt;code&gt;Media cache retention period&lt;/code&gt; under 
Settings &amp;gt; Administration &amp;gt; Server Settings &amp;gt; Content retention set at &lt;code&gt;7 days&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;After backing up the database and media, I looked up ways to reduce the amount of data 
I need to download over my 4G connection during the server move and &lt;a href="https://ricard.dev/improving-mastodons-disk-usage/"&gt;found a blog post
that solved my query&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;While running each command seperately, I noticed 1 million+ statuses,
some 300,000+ photos and 800,000+ header images getting purged.
That's a lot of storage and liability!&lt;/p&gt;
&lt;p&gt;After the purge, I now have a ~700MB database and ~26 GB in media.&lt;/p&gt;
&lt;p&gt;If I have not interacted with a post in a day, I'm likely not going to.
Hence, setting up the cron script to regularly purge posts and media after 1 day.&lt;/p&gt;
&lt;p&gt;Here's my crontab entry:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="mf"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*/&lt;/span&gt;&lt;span class="mf"&gt;3&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;bin&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;bash&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;home&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;mastodon&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;purge&lt;/span&gt;&lt;span class="mf"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sh&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;And here's &lt;code&gt;purge.sh&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="ch"&gt;#!/bin/bash&lt;/span&gt;

&lt;span class="c1"&gt;# Prune remote accounts that never interacted with a local user&lt;/span&gt;
&lt;span class="nv"&gt;RAILS_ENV&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;production&lt;span class="w"&gt; &lt;/span&gt;/home/mastodon/live/bin/tootctl&lt;span class="w"&gt; &lt;/span&gt;accounts&lt;span class="w"&gt; &lt;/span&gt;prune&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="c1"&gt;# Remove remote statuses that local users never interacted with older than 1 days&lt;/span&gt;
&lt;span class="nv"&gt;RAILS_ENV&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;production&lt;span class="w"&gt; &lt;/span&gt;/home/mastodon/live/bin/tootctl&lt;span class="w"&gt; &lt;/span&gt;statuses&lt;span class="w"&gt; &lt;/span&gt;remove&lt;span class="w"&gt; &lt;/span&gt;--days&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="c1"&gt;# Remove media attachments older than 4 days&lt;/span&gt;
&lt;span class="nv"&gt;RAILS_ENV&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;production&lt;span class="w"&gt; &lt;/span&gt;/home/mastodon/live/bin/tootctl&lt;span class="w"&gt; &lt;/span&gt;media&lt;span class="w"&gt; &lt;/span&gt;remove&lt;span class="w"&gt; &lt;/span&gt;--days&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="c1"&gt;# Remove all headers (including people I follow)&lt;/span&gt;
&lt;span class="nv"&gt;RAILS_ENV&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;production&lt;span class="w"&gt; &lt;/span&gt;/home/mastodon/live/bin/tootctl&lt;span class="w"&gt; &lt;/span&gt;media&lt;span class="w"&gt; &lt;/span&gt;remove&lt;span class="w"&gt; &lt;/span&gt;--remove-headers&lt;span class="w"&gt; &lt;/span&gt;--include-follows&lt;span class="w"&gt; &lt;/span&gt;--days&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="c1"&gt;# Remove link previews older than 16 days &lt;/span&gt;
&lt;span class="c1"&gt;# Not 1 day as they aren&amp;#39;t fetched for ~14 days since posted-at date&lt;/span&gt;
&lt;span class="nv"&gt;RAILS_ENV&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;production&lt;span class="w"&gt; &lt;/span&gt;/home/mastodon/live/bin/tootctl&lt;span class="w"&gt; &lt;/span&gt;preview_cards&lt;span class="w"&gt; &lt;/span&gt;remove&lt;span class="w"&gt; &lt;/span&gt;--days&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;16&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="c1"&gt;# Remove files not linked to any post&lt;/span&gt;
&lt;span class="nv"&gt;RAILS_ENV&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;production&lt;span class="w"&gt; &lt;/span&gt;/home/mastodon/live/bin/tootctl&lt;span class="w"&gt; &lt;/span&gt;media&lt;span class="w"&gt; &lt;/span&gt;remove-orphans&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content><category term="Mastodon"></category></entry></feed>